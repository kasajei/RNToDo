// write = create, update, delete
// read = get, list

service cloud.firestore {
  match /databases/{database}/documents {
    // match /{document=**} {
    //   allow read, write;
    // }

    function isOwner(){
      return request.auth.uid == resource.data.userId
    }

    function isShared(){
      return request.auth.uid in resource.data.sharedUsers.keys() || request.auth.uid in request.resource.data.sharedUsers.keys()
    }

    function hasShareId(){
      return request.resource.data.shareId != null
    }

    match /test/{todoId} {
      allow read, create: if request.auth.uid != null;
      allow update, delete: if isOwner() || isShared() || hasShareId();

      function accessTask(){
        return request.auth.uid in get(/databases/$(database)/documents/test/$(todoId)).data.sharedUsers.keys()
      }
      match /task/{taskId} {
        allow read, write: if accessTask();
      }
    }

    
  }
}
